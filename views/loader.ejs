<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading...</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0a;
      --text: #fafafa;
      --text-muted: #71717a;
      --accent: #e11d48;
      --accent-glow: rgba(225, 29, 72, 0.4);
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
    }

    .loader-container {
      text-align: center;
      padding: 20px;
    }

    /* Spinner */
    .spinner {
      width: 48px;
      height: 48px;
      margin: 0 auto 24px;
      position: relative;
    }

    .spinner::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 3px solid var(--text-muted);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Status text */
    .status {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 8px;
      transition: opacity 0.2s ease;
    }

    .status-sub {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    /* Dots animation */
    .dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    /* Error state */
    .error-container {
      display: none;
    }

    .error-container.show {
      display: block;
    }

    .error-container .status {
      color: #fca5a5;
    }

    .retry-btn {
      margin-top: 16px;
      background: var(--accent);
      color: white;
      border: none;
      padding: 10px 24px;
      font-size: 0.875rem;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .retry-btn:hover {
      opacity: 0.9;
    }

    /* Hide loading when error shows */
    .loading-container.hide {
      display: none;
    }
  </style>
</head>
<body>
  <div class="loader-container">
    <!-- Loading State -->
    <div class="loading-container" id="loadingState">
      <div class="spinner"></div>
      <div class="status"><span id="statusText">Connecting</span><span class="dots"></span></div>
      <div class="status-sub" id="statusSub">Please wait</div>
    </div>

    <!-- Error State -->
    <div class="error-container" id="errorState">
      <div class="status">Connection failed</div>
      <div class="status-sub">Something went wrong. Please try again.</div>
      <button class="retry-btn" onclick="startLoading()">Try Again</button>
    </div>
  </div>

  <script>
    const CONFIG = {
      returnUrl: <%- JSON.stringify(returnUrl || "/browse") %>,
      maxRetries: 3,
      timeout: 20000 // 20 seconds max
    };

    let retryCount = 0;
    let timeoutId = null;

    const statusText = document.getElementById('statusText');
    const statusSub = document.getElementById('statusSub');
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');

    function updateStatus(text, sub) {
      statusText.textContent = text;
      if (sub) statusSub.textContent = sub;
    }

    function showError() {
      loadingState.classList.add('hide');
      errorState.classList.add('show');
    }

    function hideError() {
      loadingState.classList.remove('hide');
      errorState.classList.remove('show');
    }

    function goToTarget() {
      if (timeoutId) clearTimeout(timeoutId);
      updateStatus('Ready', 'Opening...');
      
      // Small delay for UX (see "Ready" message)
      setTimeout(() => {
        window.location.href = CONFIG.returnUrl;
      }, 200);
    }

    async function warmupProxy() {
      updateStatus('Connecting', 'Setting up secure connection');
      
      try {
        const response = await fetch('/api/warmup-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin'
        });

        if (!response.ok) {
          throw new Error('Warmup failed');
        }

        const data = await response.json();
        
        if (data.success) {
          console.log('[Loader] Proxy ready:', data.status);
          goToTarget();
          return true;
        } else {
          throw new Error(data.message || 'Unknown error');
        }
      } catch (error) {
        console.error('[Loader] Warmup error:', error);
        return false;
      }
    }

    async function startLoading() {
      hideError();
      retryCount = 0;
      
      // Set timeout for max wait
      timeoutId = setTimeout(() => {
        console.log('[Loader] Timeout reached, proceeding anyway');
        goToTarget();
      }, CONFIG.timeout);

      // Try warmup with retries
      while (retryCount < CONFIG.maxRetries) {
        retryCount++;
        
        if (retryCount > 1) {
          updateStatus('Retrying', `Attempt ${retryCount} of ${CONFIG.maxRetries}`);
          await new Promise(r => setTimeout(r, 1000)); // Wait 1 sec before retry
        }

        const success = await warmupProxy();
        if (success) return;
      }

      // All retries failed
      if (timeoutId) clearTimeout(timeoutId);
      showError();
    }

    // Start on page load
    document.addEventListener('DOMContentLoaded', startLoading);
  </script>
</body>
</html>
